<!DOCTYPE html>
<html>
  <head>
    <title>Loopback: Find & Sift – The Cat In The Hack – Findings, musings and how-tos on full-stack end-to-end software craftsmanship.</title>    <meta charset="utf-8" />
    <meta content='text/html; charset=utf-8' http-equiv='Content-Type'>
    <meta http-equiv='X-UA-Compatible' content='IE=edge'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1.0'>

    
    <meta name="description" content="About this post

" />
    <meta property="og:description" content="About this post

" />
    
    <meta name="author" content="The Cat In The Hack" />

    
    <meta property="og:title" content="Loopback: Find & Sift" />
    <meta property="twitter:title" content="Loopback: Find & Sift" />
    
    <link href="/site.css" rel="stylesheet" type="text/css">
    <link href="/js/prism/prism.css" rel="stylesheet" type="text/css">
    <link href="/fonts/ionicons/css/ionicons.min.css" rel="stylesheet" type="text/css">
    <link href="/feed.xml" rel="alternate" title="The Cat In The Hack - Findings, musings and how-tos on full-stack end-to-end software craftsmanship." type="application/rss+xml">
  </head>
  <body>
    <div class="body-wrapper">
      <div class="header-wrapper">
        <div class="header">
          <div class="logo"><a href="/">
              <h1>N</h1></a></div>
          <div class="banner">
            <h1 class="site-name">The Cat In The Hack</h1>
          </div>
          <div class="navigation">
            <ul>
              <li><a href="/">Posts</a></li>
              <li><a href="/about/">About</a></li>
            </ul>
          </div>
        </div>
      </div>
      <div class="clearfix"></div>
      <div class="content post">
        <div class="post-header"><span class="post-date"><span class="day-month">Apr&nbsp;24</span><span class="year">2016</span></span>
          <h1 class="post-title">Loopback: Find & Sift</h1><span class="post-subtitle">Filtering results on related object's properties</span>
        </div>
        <div class="post-toc"><ul class="section-nav">
<li class="toc-entry toc-h2"><a href="#about-this-post">About this post</a></li>
<li class="toc-entry toc-h3"><a href="#what-will-you-find-here-tldr">What will you find here? (TL;DR)</a></li>
<li class="toc-entry toc-h3"><a href="#who-is-this-post-for">Who is this post for?</a></li>
<li class="toc-entry toc-h2"><a href="#setting-up-our-example">Setting up our example</a></li>
<li class="toc-entry toc-h3"><a href="#some-loopback-context">Some loopback context</a></li>
<li class="toc-entry toc-h3"><a href="#get-the-sample-project-code">Get the sample project code</a></li>
<li class="toc-entry toc-h3"><a href="#our-models-and-relations">Our models and relations</a></li>
<li class="toc-entry toc-h2"><a href="#a-query-progression">A query progression</a></li>
<li class="toc-entry toc-h3"><a href="#the-simplest-query">The simplest query</a></li>
<li class="toc-entry toc-h3"><a href="#a-simple-query-with-include">A simple query, with include</a></li>
<li class="toc-entry toc-h3"><a href="#a-simple-query-with-include-and-a-where-clause">A simple query with include and a where clause</a></li>
<li class="toc-entry toc-h3"><a href="#cant-filter-on-a-related-models-properties">Can’t filter on a related model’s properties</a></li>
<li class="toc-entry toc-h2"><a href="#whats-going-on-loopback">What’s going on, loopback?</a></li>
<li class="toc-entry toc-h3"><a href="#mental-model-mismatch">Mental model mismatch</a></li>
<li class="toc-entry toc-h3"><a href="#a-imperative-two-step-workaround">A imperative, two-step, workaround</a></li>
<li class="toc-entry toc-h4"><a href="#first-find">First, find…</a></li>
<li class="toc-entry toc-h4"><a href="#and-then-sift">…and then: sift!</a></li>
<li class="toc-entry toc-h3"><a href="#implementation">Implementation</a></li>
<li class="toc-entry toc-h3"><a href="#revisiting-that-troubled-query">Revisiting that troubled query</a></li>
<li class="toc-entry toc-h2"><a href="#get-it">Get it</a></li>
<li class="toc-entry toc-h3"><a href="#installing">Installing</a></li>
<li class="toc-entry toc-h4"><a href="#is-the-sift-remote-method-not-appearing-on-the-api-explorer">Is the sift remote method not appearing on the API Explorer?</a></li>
<li class="toc-entry toc-h3"><a href="#usage">Usage</a></li>
<li class="toc-entry toc-h2"><a href="#now-for-some-perspective">Now, for some perspective</a></li>
<li class="toc-entry toc-h3"><a href="#pros">Pros</a></li>
<li class="toc-entry toc-h3"><a href="#cons">Cons</a></li>
<li class="toc-entry toc-h4"><a href="#limit-and-offset">LIMIT and OFFSET</a></li>
<li class="toc-entry toc-h4"><a href="#youre-bringing-it-all-to-memory">You’re bringing it all to memory!</a></li>
<li class="toc-entry toc-h2"><a href="#what-now">What now?</a></li>
<li class="toc-entry toc-h3"><a href="#related-resources">Related resources</a></li>
<li class="toc-entry toc-h3"><a href="#coming-up-next">Coming up next…</a></li>
<li class="toc-entry toc-h3"><a href="#thanks">Thanks</a></li>
</ul></div>
        <div class="post-body"><h2 id="about-this-post">
<a id="about-this-post" class="anchor" href="#about-this-post" aria-hidden="true"><span class="octicon octicon-link"></span></a>About this post</h2>

<h3 id="what-will-you-find-here-span-classabbrtldrspan">
<a id="what-will-you-find-here-tldr" class="anchor" href="#what-will-you-find-here-tldr" aria-hidden="true"><span class="octicon octicon-link"></span></a>What will you find here? <span class="abbr">(TL;DR)</span>
</h3>
<ul class="bullet">
  <li>How loopback’s includes won’t work as expected, when you’re expecting it to work like <span class="abbr">SQL</span>’s <code>WHERE</code>! :P</li>
  <li>A workaround so you can query loopback AND then sift (filter) your results using data anywhere in your results data structure.</li>
  <li>A tiny piece of code you can drop, as is, in your loopback project, to have this workaround enabled, at app boot time, in all your models.</li>
</ul>

<p>In a hurry?</p>

<ul class="bullet">
  <li>Then place <a href="http://www.github.com/The-Cat-in-the-Hack/loopback-find-sift/blob/master/server/boot/sift.js" target="_blank">this file</a> in your <code>server/boot/</code> folder and run <code>npm install --save sift</code>;</li>
  <li>Use the added method in the nodejs api, or use the remote method exposed in the <span class="abbr">REST API</span>.
    <ul>
      <li>First argument is the usual filter object</li>
      <li>Second argument is the object we’ll sift with. Read <a href="https://github.com/crcn/sift.js#features" target="_blank">the sift docs</a> for the syntax.</li>
    </ul>
  </li>
</ul>

<h3 id="who-is-this-post-for">
<a id="who-is-this-post-for" class="anchor" href="#who-is-this-post-for" aria-hidden="true"><span class="octicon octicon-link"></span></a>Who is this post for?</h3>

<p>If your loopback progression was anything like mine, it probably went like this:</p>

<ul class="bullet">
  <li>get some models definitions going, create some things!</li>
  <li>retrieve things from your api client <small>— yay it works!</small>
</li>
  <li>then, retrieve things with some criteria</li>
  <li>get some relation definitions going, create related things!</li>
  <li>retrieve related things from your api client <small>— yay it works!</small>
</li>
  <li>try and fail to retrieve things with criteria spanning over relationships <small>— ooops…</small>
</li>
  <li>read and re-read the documentation <small>— what’s wrong with my code?!</small>
</li>
  <li>start writing custom remote methods to wrap multi-step queries  <small>— what’s wrong with loopback?!</small>
</li>
  <li>write one custom remote method too many, feels tired of this stuff  <small>— remote method fatigue kicks in</small>
</li>
</ul>

<p>Then this post is for you! :)</p>

<h2 id="setting-up-our-example">
<a id="setting-up-our-example" class="anchor" href="#setting-up-our-example" aria-hidden="true"><span class="octicon octicon-link"></span></a>Setting up our example</h2>

<h3 id="some-loopback-context">
<a id="some-loopback-context" class="anchor" href="#some-loopback-context" aria-hidden="true"><span class="octicon octicon-link"></span></a>Some loopback context</h3>

<p><small>You can skip this if you’re familiar with loopback.</small></p>

<ul class="bullet">
  <li>Server-side js, runs on node, on top of express. It’s a framework on the BaaS (Backend as a Service) space, kinda like Parse. I consider it to e deployd’s “spiritual successor”, given the shared core developers.</li>
  <li>The idea is that we get a lot of speed and flexibility when we write our backend with loopback models, relations, remote methods. <span class="abbr">ACL</span>s, and so on, being able to reach out for the nodejs library ecossystem and avaliable expressjs middlewares is also really good.</li>
  <li>We can pick from a number of supported persistence backends, across different database paradigms, for our data, and that choice is on a model-by-model basis. Then there’s a query feature that makes sure that it’s still possible to reach out for related data, no matter where it is being persisted.</li>
  <li>Said query feature is good, but has limitations. The downside of that flexibility is that loopback can’t be smarter than the dumbest of the all officially-supported database’s query languages. So, we’re kinda getting the lowest common denominator here.</li>
</ul>

<h3 id="get-the-sample-project-code">
<a id="get-the-sample-project-code" class="anchor" href="#get-the-sample-project-code" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get the sample project code</h3>

<p>To play with the <a href="http://www.github.com/The-Cat-in-the-Hack/loopback-find-sift" target="_blank">example project</a>, follow these steps.</p>

<pre><code class="language-bash">$ git clone http://www.github.com/The-Cat-in-the-Hack/loopback-find-sift.git
$ cd loopback-find-sift
$ npm install
$ node .
</code></pre>

<p>then in another terminal, run</p>

<pre style="white-space:pre-wrap !important;"><code class="language-bash">$ curl -gs 'http://localhost:3000/api/Albums/sift?filter={"include":["artist","label"]}&amp;sift={"artist":{"name":"Pink+Floyd"},"label":{"name":"EMI"}}'  | jq .
</code></pre>

<p>and you should get this output:</p>

<pre><code class="language-json">[
  {
    "title": "The Dark Side of the Moon",
    "id": 2,
    "artistId": 1,
    "labelId": 1,
    "artist": {
      "name": "Pink Floyd",
      "id": 1
    },
    "label": {
      "name": "EMI",
      "id": 1
    }
  }
]
</code></pre>

<h3 id="our-models-and-relations">
<a id="our-models-and-relations" class="anchor" href="#our-models-and-relations" aria-hidden="true"><span class="octicon octicon-link"></span></a>Our models and relations</h3>

<p>Let’s get a model going, using this diagram in <strong>Fig. 1</strong> as a starting point.</p>

<figure class="example">
		<img src="/diagrams/posts/loopback-find-n-sift/er.png" alt="" class="plantuml">
		<figcaption class="example-figcaption">
			<strong>Fig. 1 | </strong>Entity-Relationship diagram for our sample model
		</figcaption>
</figure>

<p class="code-caption"><code>common/models/artist.json</code></p>

<pre style="white-space:pre-wrap;"><code class="language-json">{
  "name": "Artist",
  "plural": "Artists",
  "base": "PersistedModel",
  "idInjection": true,
  "options": {
    "validateUpsert": true
  },
  "properties": {
    "name": {
      "type": "string",
      "required": true
    }
  },
  "validations": [],
  "relations": {
    "albums": {
      "type": "hasMany",
      "model": "Album",
      "foreignKey": ""
    }
  },
  "acls": [],
  "methods": {}
}
</code></pre>

<p class="code-caption"><code>common/models/album.json</code></p>

<pre style="white-space:pre-wrap;"><code class="language-json">{
  "name": "Album",
  "plural": "Albums",
  "base": "PersistedModel",
  "idInjection": true,
  "options": {
    "validateUpsert": true
  },
  "properties": {
    "title": {
      "type": "string",
      "required": true
    }
  },
  "validations": [],
  "relations": {
    "artist": {
      "type": "belongsTo",
      "model": "Artist",
      "foreignKey": ""
    },
    "label": {
      "type": "belongsTo",
      "model": "Label",
      "foreignKey": ""
    }
  },
  "acls": [],
  "methods": {}
}
</code></pre>

<p class="code-caption"><code>common/models/label.json</code></p>

<pre style="white-space:pre-wrap;"><code class="language-json">{
  "name": "Label",
  "plural": "Labels",
  "base": "PersistedModel",
  "idInjection": true,
  "options": {
    "validateUpsert": true
  },
  "properties": {
    "name": {
      "type": "string",
      "required": true
    }
  },
  "validations": [],
  "relations": {
    "albums": {
      "type": "hasMany",
      "model": "Album",
      "foreignKey": ""
    }
  },
  "acls": [],
  "methods": {}
}
</code></pre>

<p>And we’ll populate it with the data shown in <strong>Fig. 2</strong> below <a href="http://www.github.com/The-Cat-in-the-Hack/loopback-find-sift/blob/master/server/boot/sample-data.js" target="_blank">at boot time</a>:</p>

<figure class="example">
		<img src="/diagrams/posts/loopback-find-n-sift/data.png" alt="" class="plantuml">
		<figcaption class="example-figcaption">
			<strong>Fig. 2 | </strong>Our sample data.
		</figcaption>
</figure>

<h2 id="a-query-progression">
<a id="a-query-progression" class="anchor" href="#a-query-progression" aria-hidden="true"><span class="octicon octicon-link"></span></a>A query progression</h2>

<p>This is our default callback. From now on, we’ll refer to it just as <code>cb</code> in our code snippets.</p>

<pre><code class="language-javascript">function cb(error, result) {
  if (!error) {
    // do something with the result
  }
  else {
    // do something about the error
  }
}
</code></pre>

<h3 id="the-simplest-query">
<a id="the-simplest-query" class="anchor" href="#the-simplest-query" aria-hidden="true"><span class="octicon octicon-link"></span></a>The simplest query</h3>

<p>Suppose we want <strong>All labels</strong>. We write:</p>

<pre><code class="language-javascript">Label.find({}, cb);
</code></pre>

<p>and we get this as the result:</p>

<pre><code class="language-json">[
  {
    "name": "EMI",
    "id": 1
  },
  {
    "name": "Parlophone",
    "id": 2
  },
  {
    "name": "One Little Indian",
    "id": 3
  }
]
</code></pre>

<p>Now (please bear with me, this will become relevant soon) if I were to write this in plain <span class="abbr">SQL</span>, this would be it:</p>

<pre><code class="language-sql">SELECT * from label;
</code></pre>

<p>Ok?</p>

<p>Moving on…</p>

<h3 id="a-simple-query-with-include">
<a id="a-simple-query-with-include" class="anchor" href="#a-simple-query-with-include" aria-hidden="true"><span class="octicon octicon-link"></span></a>A simple query, with include</h3>

<p>Now let’s say we want <strong>All labels, including their albums</strong>.</p>

<p>We write this:</p>

<pre><code class="language-javascript">Label.find(
    { include: ['albums'] },
    cb
  );
</code></pre>

<p>And get this:</p>

<pre><code class="language-json">[
  {
    "name": "EMI",
    "id": 1,
    "albums": [
      {
        "title": "The Dark Side of the Moon",
        "id": 2,
        "artistId": 1,
        "labelId": 1
      },
      {
        "title": "Fear of the Dark",
        "id": 4,
        "artistId": 2,
        "labelId": 1
      }
    ]
  },
  {
    "name": "Parlophone",
    "id": 2,
    "albums": [
      {
        "title": "The Endless River",
        "id": 1,
        "artistId": 1,
        "labelId": 2
      },
      {
        "title": "The Book of Souls",
        "id": 3,
        "artistId": 2,
        "labelId": 2
      }
    ]
  },
  {
    "name": "One Little Indian",
    "id": 3,
    "albums": [
      {
        "title": "Selmasons: Dancer In The Dark",
        "id": 5,
        "artistId": 3,
        "labelId": 3
      }
    ]
  }
]
</code></pre>

<p>And the corresponding <span class="abbr">SQL</span> would be:</p>

<pre><code class="language-sql">SELECT * from label, album
WHERE label.id = album.labelId;
</code></pre>

<p>I hope we’re making sense so far.</p>

<p>Continuing…</p>

<h3 id="a-simple-query-with-include-and-a-where-clause">
<a id="a-simple-query-with-include-and-a-where-clause" class="anchor" href="#a-simple-query-with-include-and-a-where-clause" aria-hidden="true"><span class="octicon octicon-link"></span></a>A simple query with include and a where clause</h3>

<p>Now let’s retrieve <strong>all albums matching a certain property, and include their labels and artists</strong>.</p>

<p>We write this:</p>

<pre><code class="language-javascript">Album.find(
    {
      where: {
        title: 'The Dark Side of the Moon'
      },
      include: ['artist', 'label']
    },
    cb
  );
</code></pre>

<p>And get this:</p>

<pre><code class="language-json">[
  {
    "title": "The Dark Side of the Moon",
    "id": 2,
    "artistId": 1,
    "labelId": 1,
    "artist": {
      "name": "Pink Floyd",
      "id": 1
    },
    "label": {
      "name": "EMI",
      "id": 1
    }
  }
]
</code></pre>

<p>And this is the <span class="abbr">SQL</span> I’d write to get the same results.</p>

<pre><code class="language-sql">SELECT * from label, artist, album
WHERE album.artistId = artist.id
AND album.labelId = label.id
AND album.title = "The Dark Side of the Moon";
</code></pre>

<p>By the way, I’m sticking to <code>WHERE</code> clauses instead of <code>JOIN</code> to keep it simple and avoid discussing the <a href="http://blog.codinghorror.com/a-visual-explanation-of-sql-joins/" target="_blank">different types of <code>JOIN</code>s</a>, which can be confusing to some.</p>

<p>Until this point, thinking of loopback’s <code>include</code>s as being something like <span class="abbr">SQL</span>’s <code>JOIN</code>s was harmless.</p>

<p>But this is as far as we could get without breaking that mental model.</p>

<p>Let’s see what happens next.</p>

<h3 id="cant-filter-on-a-related-models-properties">
<a id="cant-filter-on-a-related-models-properties" class="anchor" href="#cant-filter-on-a-related-models-properties" aria-hidden="true"><span class="octicon octicon-link"></span></a>Can’t filter on a related model’s properties</h3>

<p>Let’s try to get <strong>all albums by Pink Floyd and released by EMI</strong>.</p>

<p>Because now we want to <code>include</code> and also apply a <code>where</code> clause at the same time, we need to switch to this alternate <a href="https://docs.strongloop.com/display/public/LB/Include+filter#Includefilter-Includewithfilters" target="_blank"><code>include</code> with filters</a> syntax.</p>

<p>We write this:</p>

<pre><code class="language-javascript">Album.find(
    {
      include: [
        {
          relation: 'label',
          scope: {
            where: { name: 'EMI' }
          }
        },
        {
          relation: 'Artist',
          scope: {
            where: { name: 'Pink Floyd' }
          }
        },
       ]
    },
    cb
  );
</code></pre>

<p>And get this:</p>

<pre><code class="language-json">[
  {
    "title": "The Endless River",
    "id": 1,
    "artistId": 1,
    "labelId": 2,
    "artist": {
      "name": "Pink Floyd",
      "id": 1
    }
  },
  {
    "title": "The Dark Side of the Moon",
    "id": 2,
    "artistId": 1,
    "labelId": 1,
    "label": {
      "name": "EMI",
      "id": 1
    },
    "artist": {
      "name": "Pink Floyd",
      "id": 1
    }
  },
  {
    "title": "The Book of Souls",
    "id": 3,
    "artistId": 2,
    "labelId": 2
  },
  {
    "title": "Fear of the Dark",
    "id": 4,
    "artistId": 2,
    "labelId": 1,
    "label": {
      "name": "EMI",
      "id": 1
    }
  },
  {
    "title": "Selmasons: Dancer In The Dark",
    "id": 5,
    "artistId": 3,
    "labelId": 3
  }
]
</code></pre>

<p>But this is what I was expecting:</p>

<pre><code class="language-json">[
  {
    "title": "The Dark Side of the Moon",
    "id": 2,
    "artistId": 1,
    "labelId": 1,
    "artist": {
      "name": "Pink Floyd",
      "id": 1
    },
    "label": {
      "name": "EMI",
      "id": 1
    }
  }
]
</code></pre>

<p>And the corresponding <span class="abbr">SQL</span> query is not that much different from the others in the examples above.</p>

<pre><code class="language-sql">SELECT *
FROM album, artist, label
WHERE album.artistId = artist.id
AND album.labelId = label.id
AND label.name = "EMI"
AND artist.name = "Pink Floyd";
</code></pre>

<h2 id="whats-going-on-loopback">
<a id="whats-going-on-loopback" class="anchor" href="#whats-going-on-loopback" aria-hidden="true"><span class="octicon octicon-link"></span></a>What’s going on, loopback?</h2>

<h3 id="mental-model-mismatch">
<a id="mental-model-mismatch" class="anchor" href="#mental-model-mismatch" aria-hidden="true"><span class="octicon octicon-link"></span></a>Mental model mismatch</h3>

<p>Surprised by the returned data?</p>

<p>Then you probably’ve been “thinking in SQL” until now. I know I was, when this happened to me.</p>

<p>SQL is a declarative programming language. That is to say: with <span class="abbr">SQL</span>, we describe <strong>what</strong> we want from the database, and it’s the database’s job to figure out the <strong>how</strong> of getting it for us.</p>

<p>Loopback’s queries, on the other hand, behave like steps in a imperative programming language. We have state: the data structure holding the results gathered so far. Each included relation can change that state by adding more data to it, but they can’t change or remove data already there. When all <code>include</code>s in the query have been processed the resulting data structure is returned. Check <strong>Fig. 3</strong> below:</p>

<figure class="example">
		<img src="/diagrams/posts/loopback-find-n-sift/sequence_find.png" alt="" class="plantuml">
		<figcaption class="example-figcaption">
			<strong>Fig. 3 | </strong>How a loopback query with <code>include</code>s is processed.
		</figcaption>
</figure>

<h3 id="a-imperative-two-step-workaround">
<a id="a-imperative-two-step-workaround" class="anchor" href="#a-imperative-two-step-workaround" aria-hidden="true"><span class="octicon octicon-link"></span></a>A imperative, two-step, workaround</h3>

<p>Now that our problem is clearly defined, it’s easy to come up with a two-step workaround.</p>

<h4 id="first-find">
<a id="first-find" class="anchor" href="#first-find" aria-hidden="true"><span class="octicon octicon-link"></span></a>First, find…</h4>

<p>First step is just about gathering data. Vanilla loopback includes do a decent job at this. Nothing unusual here.</p>

<h4 id="and-then-sift">
<a id="and-then-sift" class="anchor" href="#and-then-sift" aria-hidden="true"><span class="octicon octicon-link"></span></a>…and then: sift!</h4>

<p>The second step is where we keep the data we want, and discard the rest! And that’s all, check <strong>Fig. 4</strong> below:</p>

<p>From the alternatives mentioned <a href="https://github.com/strongloop/loopback/issues/517#issuecomment-53875379" target="_blank">in this github issue</a> I liked <a href="https://github.com/crcn" target="_blank">Craig Condon</a>’s <a href="https://github.com/crcn/sift.js" target="_blank">sift</a> the most. It’s neat, simple and does its job well.</p>

<figure class="example">
		<img src="/diagrams/posts/loopback-find-n-sift/sequence_find_sift.png" alt="" class="plantuml">
		<figcaption class="example-figcaption">
			<strong>Fig. 4 | </strong>Our two-step query.
		</figcaption>
</figure>

<p>Looks a lot like that other diagram above, right? I know. It’s really that simple! :)</p>

<h3 id="implementation">
<a id="implementation" class="anchor" href="#implementation" aria-hidden="true"><span class="octicon octicon-link"></span></a>Implementation</h3>

<p>Here’s the source code for our <code>sift.js</code>:</p>

<pre class="line-numbers" style="white-space:pre-wrap;"><code class="language-javascript">var loopbackUtils = require('loopback/lib/utils');
var sift = require('sift');

module.exports = function (app) {

  // must be a subclass of PersistedModel -- we need find();
  var siftTargets = [
    //   "Album",
    //   "Artist"
  ];

  // comment this out if you don't want this added to all your models
  var PersistedModel = app.registry.getModel('PersistedModel');
  app.models()
      .forEach(
          function (Model) {
            if (Model.prototype instanceof PersistedModel) {
              siftTargets.push(Model.definition.name);
            }
          }
      );

  // let's work on the models now
  siftTargets.forEach(
      function (target) {

        // expose as remote method
        app.models[target].remoteMethod(
            "sift",
            {
              http: {
                verb: "get",
                path: "/sift"
              },
              description: "find + sift",
              returns: [
                {
                  arg: target,
                  type: '[' + target + ']',
                  root: true
                }
              ],
              accepts: [
                {
                  arg: "filter",
                  type: "object",
                  required: false,
                  description: [
                    "The usual filter, see https://docs.strongloop.com/display/public/LB/Querying+data and",
                    "please notice 'limit' and 'offset' are performed _before_ the sifting."
                  ]
                },
                {
                  arg: "sift",
                  type: "object",
                  required: false,
                  description: "Sift through find() results, see https://github.com/crcn/sift.js."
                },
                {
                  arg: "options",
                  type: "object",
                  required: false,
                  description: "Optional options object, passed to find."
                }
              ]
            }
        );

        // the sift method itself
        app.models[target].sift = function (filterObj, siftObj, optionsObj, cb) {

          // handling optional arguments
          if (typeof filterObj == 'function') {
            // only arg was the callback
            cb = filterObj;
            filterObj = {};
            siftObj = {};
            optionsObj = {};
          }
          else if (typeof siftObj == 'function') {
            cb = siftObj;
            siftObj = {};
            optionsObj = {};
          }
          else if (typeof optionsObj == 'function') {
            cb = optionsObj;
            optionsObj = {};
          }

           cb = cb || loopbackUtils.createPromiseCallback();

          app.models[target].find(
              // filterObj = { include: { relation: "posts", scope: { where: { title: { like: "%Rabbit%" } } } } }
              filterObj || {},
              optionsObj || {},
              function (error, results) {
                if (!error) {
                  results.forEach(
                      function (element, index, array) {
                        // see https://docs.strongloop.com/display/public/LB/Include+filter#Includefilter-Accessincludedobjects
                        array[index] = element.toJSON();
                      }
                  );
                  // siftObj = { posts: { $not: { $size: 0 } }
                  results = sift(siftObj || {}, results);
                  cb(null, results);
                }
                else {
                  cb(error, null);
                }
              } // find callback
          ); // find

          return cb.promise;

        }; // sift

      } // function
  ); // foreach siftTargets
}; // exports
</code></pre>

<h3 id="revisiting-that-troubled-query">
<a id="revisiting-that-troubled-query" class="anchor" href="#revisiting-that-troubled-query" aria-hidden="true"><span class="octicon octicon-link"></span></a>Revisiting that troubled query</h3>

<p>Recap: we wanted <strong>all albums by Pink Floyd and released by EMI</strong>.</p>

<p>Now we’ll write this:</p>

<pre><code class="language-javascript">Albums.sift(
    { include: [ 'artist', 'label' ] },
    {
      label: { name: 'EMI' } ,
      artist: { name: 'Pink Floyd' }
    },
    cb
  );
</code></pre>

<p>And get this:</p>

<pre><code class="language-json">[
  {
    "title": "The Dark Side of the Moon",
    "id": 2,
    "artistId": 1,
    "labelId": 1,
    "artist": {
      "name": "Pink Floyd",
      "id": 1
    },
    "label": {
      "name": "EMI",
      "id": 1
    }
  }
]
</code></pre>

<p>Which is exactly what we wanted. Beautiful, right? :)</p>

<h2 id="get-it">
<a id="get-it" class="anchor" href="#get-it" aria-hidden="true"><span class="octicon octicon-link"></span></a>Get it</h2>

<h3 id="installing">
<a id="installing" class="anchor" href="#installing" aria-hidden="true"><span class="octicon octicon-link"></span></a>Installing</h3>

<ul class="bullet">
  <li>install the <code>sift</code> npm library in your project, with:</li>
</ul>

<pre><code class="language-bash">npm install --save sift
</code></pre>

<ul class="bullet">
  <li>Drop <a href="http://www.github.com/The-Cat-in-the-Hack/loopback-find-sift/blob/master/server/boot/sift.js">this <code>sift.js</code> file</a> in your project’s <code>server/boot/</code> folder. At boot time, the sift method will be added to all your models, and also exposed as a remote method.</li>
</ul>

<h4 id="is-the-sift-remote-method-not-appearing-on-the-api-explorer">
<a id="is-the-sift-remote-method-not-appearing-on-the-api-explorer" class="anchor" href="#is-the-sift-remote-method-not-appearing-on-the-api-explorer" aria-hidden="true"><span class="octicon octicon-link"></span></a>Is the sift remote method not appearing on the API Explorer?</h4>

<p>We have two things happening as a loopback app boots:</p>

<ul class="bullet">
  <li>We’re adding our <code>sift</code> remote method.</li>
  <li>The API Explorer is going through our models, looking for remote methods to expose.</li>
</ul>

<p>If the API Explorer is configured as a loopback component, then it’s most likely that our sift method will be added <em>after</em> it. I don’t know how to tweak that.</p>

<p>The good thing is that you can enable the API Explorer from the <code>server/boot</code> folder, instead of having it configured as a compoment. Because <a href="https://docs.strongloop.com/display/public/LB/Defining+boot+scripts#Definingbootscripts-Bootscriptloadingorder" target="_blank">loopback executes them in alphabetical order</a>, it’s just a matter or naming your files accordingly.</p>

<h3 id="usage">
<a id="usage" class="anchor" href="#usage" aria-hidden="true"><span class="octicon octicon-link"></span></a>Usage</h3>

<p><code>Model.sift(filter, sift, options, callback)</code></p>

<p>
</p><dl>
	<dt><b>filter</b></dt>
	<dd>The first argument is the standard `filter` object we have in loopback. <a href="https://docs.strongloop.com/display/public/LB/Querying+data" target="_blank">Check loopback's docs</a> if needed. Mandatory.</dd>
	<dt><b>sift</b></dt>
	<dd>The second argument is the `sift object`, which will be used to sift the results returned by your `filter object` above. Optional.</dd>
  <dt><b>options</b></dt>
  <dd> The third argument is a `options` object, which, if present, will be passed to our `Model.find()` callds, As far as I'm aware, it's used in loopback only for doing operations within transactions. <a href="https://docs.strongloop.com/display/public/LB/Using+database+transactions#Usingdatabasetransactions-Performoperationsinatransaction" target="_blank">See more in the docs.</a>
</dd>
  <dt><b>callback</b></dt>
  <dd>A callback function. If omitted, then the a promise that resolves to the results will be returned. Has this signature:

    <dl>
      <dt><b>error</b></dt>
      <dd>The error object</dd>
      <dt><b>results</b></dt>
      <dd>The results.</dd>
    </dl>

  </dd>
</dl>


<h2 id="now-for-some-perspective">
<a id="now-for-some-perspective" class="anchor" href="#now-for-some-perspective" aria-hidden="true"><span class="octicon octicon-link"></span></a>Now, for some perspective</h2>

<h3 id="pros">
<a id="pros" class="anchor" href="#pros" aria-hidden="true"><span class="octicon octicon-link"></span></a>Pros</h3>

<ul class="bullet">
  <li>Think of the many, many custom methods you won’t be writing anymore.</li>
  <li>Drop-in, easy to use: let it iterate over all your Models, or give it the list of the only models you want to have this method (and its remote method).</li>
  <li>Data-source agnostic. Because we’re not breaking through loopback’s abstraction layers, your models can be anywhere, e.g. mongo, postgres, neo4j, etc and the sifting still works!</li>
  <li>A vanilla remote method, meaning it’ll appear in the swagger auto-generated documentation, you can write loopback <span class="abbr">ACL</span>s for it, and treat it like you would any remote method of your own.</li>
</ul>

<h3 id="cons">
<a id="cons" class="anchor" href="#cons" aria-hidden="true"><span class="octicon octicon-link"></span></a>Cons</h3>

<h4 id="limit-and-offset">
<a id="limit-and-offset" class="anchor" href="#limit-and-offset" aria-hidden="true"><span class="octicon octicon-link"></span></a>LIMIT and OFFSET</h4>

<p>If your pagination depends on loopback <code>filter</code>’s <code>offset</code> and <code>limit</code> clauses, passing these now probably won’t make much sense anymore. The sifting happens <em>after</em> the data is gathered. In a future (rather soonish) post I’ll show a really sane way of adding pagination to any remote method, using the method on this post as an example.</p>

<h4 id="youre-bringing-it-all-to-memory">
<a id="youre-bringing-it-all-to-memory" class="anchor" href="#youre-bringing-it-all-to-memory" aria-hidden="true"><span class="octicon octicon-link"></span></a>You’re bringing it all to memory!</h4>

<p>Yes, I am. Guilty as charged! That is because instead of bypassing loopback persisted model’s abstraction, we’re working <em>with</em> it. We ask loopback for our model’s data (wherever it might live, that’s none of our business) and then we do our sifting. This way, database persistency choices can still be made on a model-by-model basis.</p>

<p>We could have picked a different route: grabbing the persisted model’s Datasource and talk, in raw queries, to the database. What many people don’t realise, until later, is that going down this route means commiting the project, from that point on, to a database choice, for one or more models, and having query code that’s in a specific database query language.</p>

<p>So it’s a performance/flexibility tradeoff we got here. I’d suggest you to starting experiment, measuring, monitoring.</p>

<p>It could be the case that in-memory filtering is not acceptable for your scenario. Then you’re probably also at a point in the road where it makes sense to make a database choice and maybe even ditch loopback’s standard models. Pick something that really fits to your use case and data needs, and by all means write your queries against it.</p>

<p>Or it might just turn out that you’re nowhere near the point where in-memory filtering is something you have to care about. Then, relax and enjoy loopback’s datasource flexibility.</p>

<p>Then keep measuring and monitoring. And run some experiment and projection scenarios every once in a while.</p>

<p>It’s a good strategy to address potential scaling problems when your metrics and experiments show that a scaling problem could exist in the horizon, otherwise you’d be just speculating and doing premature optimization. It’s not much different from the misplaced effort of implementing complex and hard-to-get-right sorting algorithms when all you got is a 20-item array – and even bubble sort couldn’t slow you enough!</p>

<p>So, again. Measure, monitor, and keep doing it.</p>

<h2 id="what-now">
<a id="what-now" class="anchor" href="#what-now" aria-hidden="true"><span class="octicon octicon-link"></span></a>What now?</h2>

<h3 id="related-resources">
<a id="related-resources" class="anchor" href="#related-resources" aria-hidden="true"><span class="octicon octicon-link"></span></a>Related resources</h3>

<ul class="bullet">
  <li>This <a href="https://github.com/strongloop/loopback-connector/pull/40">github issue</a> that drives home the point that users often think that <code>include</code> is broken.</li>
  <li>As mentioned above, check the <a href="https://github.com/strongloop/loopback/issues/517" target="_blank">Filter on level 2 properties</a> issue on github. I suggest you +1 it and subscribe so you’ll know when an official solution comes around.</li>
  <li>The sift project on github: <a href="https://github.com/crcn/sift.js" target="_blank">https://github.com/crcn/sift.js</a>
</li>
  <li>This pending <small>(as of 2016-04-23)</small> <a href="https://github.com/strongloop/loopback-connector/pull/40">pull request</a>, with a contribution by <a href="https://github.com/DiogoDoreto">Diogo Doreto</a> to add better <code>WHERE</code> clauses support for <span class="abbr">SQL</span> datasources,. It’s been sitting there for a while, but there’s been some activity on it recently, meaning it could be on its way to the core…</li>
</ul>

<h3 id="coming-up-next">
<a id="coming-up-next" class="anchor" href="#coming-up-next" aria-hidden="true"><span class="octicon octicon-link"></span></a>Coming up next…</h3>

<p>As mentioned above, I’m working on a post about how to add beautiful, elegant, standards-compliant pagination to our remote methods! :) You might want to…</p>

<div class="card-subscribe">
          <!-- Begin MailChimp Signup Form-->
          <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
          <div id="mc_embed_signup">
            <form id="mc-embedded-subscribe-form" action="//the-cat-in-the-hack.us13.list-manage.com/subscribe/post?u=e89dfffd21bf9f6efd65f1424&amp;id=5de23922ae" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate="" class="validate">
              <div id="mc_embed_signup_scroll">
                <label for="mce-EMAIL" style='display: block; font-family: "Source Sans Pro"'>Subscribe and I'll drop you a line when a fresh new post is out of the oven! :)</label>
                <input id="mce-EMAIL" type="email" value="" name="EMAIL" placeholder="email address" required="" class="email">
                <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;" aria-hidden="true">
                  <input type="text" name="b_e89dfffd21bf9f6efd65f1424_5de23922ae" tabindex="-1" value="">
                </div>
                <div style='display: inline; font-family: "Source Sans Pro";' class="clear">
                  <input id="mc-embedded-subscribe" type="submit" value="Subscribe" name="subscribe" class="button">
                </div>
              </div>
            </form>
          </div>
          <!-- End mc_embed_signup-->
</div>

<h3 id="thanks">
<a id="thanks" class="anchor" href="#thanks" aria-hidden="true"><span class="octicon octicon-link"></span></a>Thanks</h3>

<p>For reading this far! Constructive criticism and feedback is highly appreciated! And if you need help with or around your loopback app, let me know! I’m avaliable for part-time hire or consulting arrangements.</p>
</div>
        <!-- .post-footer
        | If you enjoyed this post, then make sure you subscribe to my
        span Newsletter
        |  and/or
        span Feed
        | .
        -->
        <div class="post-comments">
          <div id="disqus_thread"></div>
          <script>
            /**
            * RECOMMENDED CONFIGURATION VARIABLES: EDIT AND UNCOMMENT THE SECTION BELOW TO INSERT DYNAMIC VALUES FROM YOUR PLATFORM OR CMS.
            * LEARN WHY DEFINING THESE VARIABLES IS IMPORTANT: https://disqus.com/admin/universalcode/#configuration-variables
            */
            
            var disqus_config = function () {
            // this.page.url = PAGE_URL; // Replace PAGE_URL with your page's canonical URL variable
            this.page.identifier = 'loopback-sift-n-find' ; // Replace PAGE_IDENTIFIER with your page's unique identifier variable
            };
            
            (function() { // DON'T EDIT BELOW THIS LINE
            var d = document, s = d.createElement('script');
            
            s.src = '//thecatinthehack.disqus.com/embed.js';
            
            s.setAttribute('data-timestamp', +new Date());
            (d.head || d.body).appendChild(s);
            })();
          </script>
        </div>
        <div class="post-footer"><a href="/" class="author"><img src="/images/tcith/tcith-01-small.png" style="width: auto"></a>
          <ul class="social-links">
            
            <li><a href="mailto:nuba@pauleira.com"><i class="icon ion-email"></i></a></li>
            
            <li><a href="https://www.facebook.com/nubarp"><i class="icon ion-social-facebook"></i></a></li>
            
            
            <li><a href="https://github.com/nuba"><i class="icon ion-social-github"></i></a></li>
            
            
            <li><a href="https://www.linkedin.com/in/nprincigalli"><i class="icon ion-social-linkedin"></i></a></li>
            
            
            
            <li><a href="https://www.twitter.com/nprincigalli"><i class="icon ion-social-twitter"></i></a></li>
            
            
            
          </ul>
          <!-- Begin MailChimp Signup Form-->
          <link href="//cdn-images.mailchimp.com/embedcode/horizontal-slim-10_7.css" rel="stylesheet" type="text/css">
          <div id="mc_embed_signup">
            <form id="mc-embedded-subscribe-form" action="//the-cat-in-the-hack.us13.list-manage.com/subscribe/post?u=e89dfffd21bf9f6efd65f1424&amp;id=5de23922ae" method="post" name="mc-embedded-subscribe-form" target="_blank" novalidate="" class="validate">
              <div id="mc_embed_signup_scroll">
                <label for="mce-EMAIL" style="display: block; font-family: &quot;Source Sans Pro&quot;">Subscribe and I'll drop you a line when a fresh new post is out of the oven! :)</label>
                <input id="mce-EMAIL" type="email" value="" name="EMAIL" placeholder="email address" required="" class="email">
                <!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
                <div style="position: absolute; left: -5000px;" aria-hidden="true">
                  <input type="text" name="b_e89dfffd21bf9f6efd65f1424_5de23922ae" tabindex="-1" value="">
                </div>
                <div style="display: inline; font-family: &quot;Source Sans Pro&quot;;" class="clear">
                  <input id="mc-embedded-subscribe" type="submit" value="Subscribe" name="subscribe" class="button">
                </div>
              </div>
            </form>
          </div>
          <!-- End mc_embed_signup-->
        </div>
      </div>
    </div>
    <script src="/js/site.js"></script>
    <script src="/js/prism/prism.js"></script>
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-76881950-1', 'auto');
      ga('send', 'pageview');
    </script>
  </body>
</html>